<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>正确释放Vector的内存 | KidLet</title>
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/post.css">
  <link rel="stylesheet" href="/assets/css/code.css">
</head>

<body>

  <div class="site">

    <header class="site-header">
      <div class="site-header-title">
        <h1><a href="/" title="KidLet" rel="KidLet">KidLet</a></h1>
        <h2>享受生活，热爱编程</h2>
      </div>

    <nav class="site-nav">
      <ul>
        
        <li>
          <a href="/" title="Home">Home</a>
        </li>
        <li>
          <a href="/doing.html">Doing</a>
        </li>
        <li>
          <a href="#">About</a>
        </li>


        <li class="site-nav-search">
          <form action="#">
            <input type="text">
            <input type="submit" value="搜索">
          </form>
        </li>

      </ul>
    </nav>

    </header>

    <div class="wrapper">
  <div class="list-content">
    <article>
	<header class="entry-header">
		<h1 class="entry-title">
			正确释放Vector的内存
		</h1>

		<div class="entry-meta">
		2013-06-03
		</div>

	</header>

	<div class="entry-content">
		<p>今天在看微博的时候， 有人提出了一个对于Vector内存泄露的疑问 <a href="http://weibo.com/1986953781/zzIQoyhcM">Link</a></p>

<p>博主采用 Vector存储一些数据，但是发现在执行 clear() 之后内存并没有释放，于是怀疑产生了内存泄露。随后有人回复</p>

<blockquote><p>vector 的 clear 不影响 capacity , 你应该 swap 一个空的 vector.</p></blockquote>

<p>开始并不知道回复者在说什么，于是在谷歌上搜索 <code>vector swap clear</code>
发现已经有类似的问题出现了，并且给出了一些解决方案。</p>

<p>原来这样的问题在 《Effective STL》中的“条款17”已经指出了</p>

<p>当vector、string大量插入数据后，即使删除了大量数据（或者全部都删除，即clear）
并没有改变容器的容量（capacity），所以仍然会占用着内存。
为了避免这种情况，我们应该想办法改变容器的容量使之尽可能小的符合当前
数据所需（shrink to fit）</p>

<p>《Effective STL》给出的解决方案是</p>

<div class="highlight"><pre><code class="c++"><span class="n">vector</span><span class="o">&lt;</span><span class="n">type</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
<span class="c1">//.... 这里添加许多元素给v</span>
<span class="c1">//.... 这里删除v中的许多元素</span>
<span class="n">vector</span><span class="o">&lt;</span><span class="n">type</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>
<span class="c1">//此时v的容量已经尽可能的符合其当前包含的元素数量</span>
<span class="c1">//对于string则可能像下面这样</span>
<span class="n">string</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</code></pre></div>


<p>即先创建一个临时拷贝与原先的vector一致，值得注意的是，此时的拷贝
其容量是尽可能小的符合所需数据的。紧接着将该拷贝与原先的vector v进行
交换。好了此时，执行交换后，临时变量会被销毁，内存得到释放。此时的v即为原先
的临时拷贝，而交换后的临时拷贝则为容量非常大的vector（不过已经被销毁）</p>

<p>为了证明这一点，我写了一个程序，如下：</p>

<div class="highlight"><pre><code class="c++"><span class="cp">#include &lt;iostream&gt;</span>
<span class="cp">#include &lt;vector&gt;</span>

<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="n">vector</span> <span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span> <span class="n">v</span><span class="p">;</span>
<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
<span class="p">{</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">1000000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">v</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;abcdefghijklmn&quot;</span><span class="p">);</span>
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">ch</span><span class="p">;</span>
    <span class="c1">// 此时检查内存情况 占用54M</span>

    <span class="n">v</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">ch</span><span class="p">;</span>
    <span class="c1">// 此时再次检查， 仍然占用54M</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Vector 的 容量为&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">// 此时容量为 1048576</span>
    
    <span class="n">vector</span><span class="o">&lt;</span><span class="n">string</span><span class="o">&gt;</span><span class="p">(</span><span class="n">v</span><span class="p">).</span><span class="n">swap</span><span class="p">(</span><span class="n">v</span><span class="p">);</span>

    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Vector 的 容量为&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
    <span class="c1">// 此时容量为0</span>
    <span class="n">cin</span> <span class="o">&gt;&gt;</span> <span class="n">ch</span><span class="p">;</span>
    <span class="c1">// 检查内存，释放了 10M+ 即为数据内存</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<h2>总结</h2>

<p>从这个事情说明，自己对STL的了解还非常的不够
平时对vector的清除都懂得采用 clear 方法</p>

<p>另一方面 对于STL的设计思想也有些了解，在创建一个vector后
vector的实际容量一般会比给数据要大，这样做应该是避免过多的
重新分配内存吧。</p>

<p>当然，上面这种方法虽然释放了内存，但是同时也增加了拷贝数据的时间消耗。
不过一般需要重新调整容量的情况都是 vector本身元素较少的情况，所以
时间消耗可以忽略不计。</p>

<p>因此建议以后大家都将调用 <code>clear()</code> 改为 <code>swap()</code> 吧。</p>

	</div>

	<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"kidlet"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- Duoshuo Comment END -->

</article>
  </div>

  <div class="list-widget-area">
    
    <aside class="widget widget_recent_entries">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
        <li>
          <a href="/2013/06-03/vector.html" title="正确释放Vector的内存">正确释放Vector的内存</a>
        <li>
        
        <li>
          <a href="/2013/05-17/mykindle.html" title="入手Kindle Paperwhite">入手Kindle Paperwhite</a>
        <li>
        
        <li>
          <a href="/2013/05-12/acmdone.html" title="省赛结束">省赛结束</a>
        <li>
        
        <li>
          <a href="/2013/05-10/newtheme.html" title="博客新主题">博客新主题</a>
        <li>
        
        <li>
          <a href="/2013/05-01/vdfuse.html" title="利用vdfuse读取 VirtualBox drive image(vdi)">利用vdfuse读取 VirtualBox drive image(vdi)</a>
        <li>
        
      </ul>
    </aside>

    <aside class="widget widget_categories">
      <h3 class="widget-title">Categories</h3>
      <ul>

        
        <li>
          <a href="/categories/web前端" title="">web前端</a>
        </li>
        
        <li>
          <a href="/categories/算法" title="">算法</a>
        </li>
        
        <li>
          <a href="/categories/随笔" title="">随笔</a>
        </li>
        
        <li>
          <a href="/categories/javascript" title="">javascript</a>
        </li>
        
        <li>
          <a href="/categories/web" title="">web</a>
        </li>
        
        <li>
          <a href="/categories/linux" title="">linux</a>
        </li>
        
        <li>
          <a href="/categories/programming" title="">programming</a>
        </li>
                

      </ul>
    </aside>
  </div>
</div>

    <footer>
      <p>Proudly powered by Jekyll</p>
      <script src="http://s14.cnzz.com/stat.php?id=5036420&web_id=5036420&online=2" language="JavaScript"></script>
    </footer>

  </div>

</body>

</html>

