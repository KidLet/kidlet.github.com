<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>多线程引起的“内存泄露” | KidLet</title>
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/post.css">
  <link rel="stylesheet" href="/assets/css/code.css">
  <meta name="author" content="KidLet">
  
    <meta content="第一次和内存泄露做斗争，结果检查了很久居然发现问题出在多线程上。" name="description">
  

  
    <meta content="linux, pthread, join, detach, 内存泄露, valgrind" name="keywords">
  

</head>

<body>

  <div class="site">

    <header class="site-header">
      <div class="site-header-title">
        <h1><a href="/" title="KidLet" rel="KidLet">KidLet</a></h1>
        <h2>享受生活，热爱编程</h2>
      </div>

    <nav class="site-nav">
      <ul>
        
        <li>
          <a href="/" title="Home">Home</a>
        </li>
<!--        
        <li>
          <a href="/doing.html">Doing</a>
        </li>
-->
        <li>
          <a href="/read.html">READ</a>
        </li>

        <li>
          <a href="/aboutme.html">About</a>
        </li>


        <li class="site-nav-search">
          <form action="#">
            <input type="text">
            <input type="submit" value="搜索">
          </form>
        </li>

      </ul>
    </nav>

    </header>

    <div class="wrapper">
  <div class="list-content">
    <article>
	<header class="entry-header">
		<h1 class="entry-title">
			多线程引起的“内存泄露”
		</h1>

		<div class="entry-meta">
		2013-06-16
		</div>

	</header>

	<div class="entry-content">
		<p>近日在写一个多线程的服务端程序，开始重视内存泄露问题。
根据观察发现每个连接大概会产生4KB左右的泄露，检查很久都没能发现
泄露的位置。后来将程序改为单线程，发现不再出现泄露问题。于是开始
怀疑是多线程导致的。后经查阅发现是线程资源没有回收导致。</p>

<h1>线程的joinable 和 detached 状态</h1>

<p>在Linux下，默认创建线程后，状态为 <code>joinable</code>。这样的线程终止时，其
终止状态会保存到对该线程调用pthread_join，并且在pthread_join被调用
之前会一直保存着其底层存储资源。这样就导致了所谓的“内存泄露”</p>

<p>但是有时候我们并不需要获取线程的终止状态，而调用pthread_join又会导致
阻塞，直至相应线程终止。这常常不是我们的本意。</p>

<p>对于这种情况，我们可以调用pthread_detach使相应线程进入 <code>detached</code>状态（分离状态）
当线程被分离时，不能再用pthread_join来等待获取它的终止状态了，此时线程结束后
资源会被立即回收。</p>

<blockquote><p>所以如果不需要获取线程的终止状态，那么就应该使其进入分离状态，从而
避免不必要的资源占用。</p></blockquote>

<h1>例子</h1>

<div class="highlight"><pre><code class="c++"><span class="kt">void</span><span class="o">*</span> <span class="nf">fun</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span> <span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">//pthread_detach(pthread_self());</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">main</span> <span class="p">()</span>
<span class="p">{</span>
    <span class="kt">pthread_t</span> <span class="n">id</span><span class="p">;</span>
 
    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
        <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    
    <span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%*s&quot;</span><span class="p">);</span>
    <span class="cm">/*</span>
<span class="cm">    此时检查内存情况，可以发现程序占用了80M+的内存。</span>
<span class="cm">    若将 fun 第一句注释去掉，重新运行，可以发现</span>
<span class="cm">    几乎不占内存了。 </span>
<span class="cm">    */</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>


<p>另外推荐下<code>Valgrind</code>真是一款强大的内存问题检测工具（不仅限于内存泄露）。</p>

	</div>

	<!-- Duoshuo Comment BEGIN -->
	<div class="ds-thread"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"kidlet"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = 'http://static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		|| document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- Duoshuo Comment END -->

</article>
  </div>

  <div class="list-widget-area">
    
    <aside class="widget widget_recent_entries">
      <h3 class="widget-title">Recent Posts</h3>
      <ul>
        
        <li>
          <a href="/2013/06-16/pthread.html" title="多线程引起的“内存泄露”">多线程引起的“内存泄露”</a>
        <li>
        
        <li>
          <a href="/2013/06-03/vector.html" title="正确释放Vector的内存">正确释放Vector的内存</a>
        <li>
        
        <li>
          <a href="/2013/05-17/mykindle.html" title="入手Kindle Paperwhite">入手Kindle Paperwhite</a>
        <li>
        
        <li>
          <a href="/2013/05-12/acmdone.html" title="省赛结束">省赛结束</a>
        <li>
        
        <li>
          <a href="/2013/05-10/newtheme.html" title="博客新主题">博客新主题</a>
        <li>
        
      </ul>
    </aside>

    <aside class="widget widget_categories">
      <h3 class="widget-title">Categories</h3>
      <ul>

        
        <li>
          <a href="/categories/web前端" title="">web前端</a>
        </li>
        
        <li>
          <a href="/categories/算法" title="">算法</a>
        </li>
        
        <li>
          <a href="/categories/随笔" title="">随笔</a>
        </li>
        
        <li>
          <a href="/categories/javascript" title="">javascript</a>
        </li>
        
        <li>
          <a href="/categories/web" title="">web</a>
        </li>
        
        <li>
          <a href="/categories/linux" title="">linux</a>
        </li>
        
        <li>
          <a href="/categories/programming" title="">programming</a>
        </li>
                

      </ul>
    </aside>
  </div>
</div>

    <footer>
      <p>Proudly powered by Jekyll</p>
      <script src="http://s14.cnzz.com/stat.php?id=5036420&web_id=5036420&online=2" language="JavaScript"></script>
    </footer>

  </div>

</body>

</html>

